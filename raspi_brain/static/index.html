<html>

<head>
  <style>
    body,
    #container {
      width: 100%;
      padding: 0px;
      margin: 0px;
    }
  </style>
</head>

<body>
  <div id="container">
  </div>

  <script src="./jquery-3.4.1.min.js"></script>
  <script src="./p5.min.js"></script>
  <script src="./p5.dom.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const buttons = {};
    function setup() {
      createCanvas(600, 600);
      buttons.home = createButton('home');
      buttons.home.mousePressed(() => {
        socket.emit('client', { command: 'home' })
      });
      buttons.drive = createButton('drive');
      buttons.drive.mousePressed(() => {
        socket.emit('client', { command: 'drive', steps: 800 })
      });
      buttons.driveTillHit = createButton('drive till hit');
      buttons.driveTillHit.mousePressed(() => {
        socket.emit('client', { command: 'driveTillHit' })
      });
      buttons.letter = createButton('letter');
      buttons.letter.mousePressed(() => {
        socket.emit('client', { command: 'letter', index: parseInt(Math.random() * 4) })
      });
      buttons.left = createButton('left');
      buttons.left.mousePressed(() => {
        socket.emit('client', { command: 'rotate', angle: 45 })
      });
      buttons.right = createButton('right');
      buttons.right.mousePressed(() => {
        socket.emit('client', { command: 'rotate', angle: -45 })
      });
    }

    const points = [];
    const bumper = { status: '' };
    const position = { x: 0, y: 0 };
    const positionTarget = { x: 0, y: 0 };
    const servo = { angle: 0 };
    function draw() {
      let bg;
      if (bumper.status == 'hit') {
        bg = [255, 0, 0];
      }
      else if (bumper.status == 'released') {
        bg = [0, 255, 0];
      }
      else
        bg = [0, 0, 0];
      background(bg[0], bg[1], bg[2]);
      translate(width / 2, height / 2);
      stroke(255);
      beginShape(POINTS);
      for (const p of points) {
        vertex(p.x, p.y);
      }
      endShape();
      fill(255);
      position.x = lerp(position.x, positionTarget.x, 0.5);
      position.y = lerp(position.y, positionTarget.y, 0.5);
      ellipse(position.x, position.y, 20, 20);
    }
    socket.on('bumper', (msg) => {
      console.log(msg)
      bumper.status = msg.status;
    });
    // socket.on('position', (msg) => {
    //   console.log(msg)
    // });
    socket.on('world', (msg) => {
      console.log(msg)
      positionTarget.x = msg.x * 0.1;
      positionTarget.y = msg.y * 0.1;
      if (servo.angle > 70) {
        points.push({ x: msg.x * 0.1, y: msg.y * 0.1 });
        if (points.length > 1000) {
          points.shift();
        }
      }
    });
    socket.on('servo', (msg) => {
      console.log(msg)
      servo.angle = msg.angle;
    });
  </script>
</body>

</html>